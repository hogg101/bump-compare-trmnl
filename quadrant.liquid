{% comment %}
  Bump Compare - TRMNL v2 Plugin
  Quadrant viewport (compact version)
{% endcomment %}

{% comment %} Icon base URL {% endcomment %}
{% assign icon_base_url = "https://raw.githubusercontent.com/hogg101/bump-compare-trmnl/main/images" %}

{% comment %} Load weeks data {% endcomment %}
{% assign weeks_data = '[
  {"week":4,"name":{"en-GB":"Poppy seed","en-US":"Poppy seed"},"length_mm":1,"weight_g":0.002,"icon":"poppy.svg"},
  {"week":8,"name":{"en-GB":"Raspberry","en-US":"Raspberry"},"length_mm":16,"weight_g":1,"icon":"raspberry.svg"},
  {"week":12,"name":{"en-GB":"Lime","en-US":"Lime"},"length_mm":58,"weight_g":14,"icon":"lime.svg"},
  {"week":16,"name":{"en-GB":"Avocado","en-US":"Avocado"},"length_mm":120,"weight_g":100,"icon":"avocado.svg"},
  {"week":20,"name":{"en-GB":"Banana","en-US":"Banana"},"length_mm":160,"weight_g":300,"icon":"banana.svg"},
  {"week":24,"name":{"en-GB":"Sweetcorn","en-US":"Corn on the cob"},"length_mm":210,"weight_g":600,"icon":"sweetcorn.svg"},
  {"week":28,"name":{"en-GB":"Aubergine","en-US":"Eggplant"},"length_mm":260,"weight_g":1000,"icon":"aubergine.svg"},
  {"week":32,"name":{"en-GB":"Butternut squash","en-US":"Butternut squash"},"length_mm":300,"weight_g":1700,"icon":"butternut.svg"},
  {"week":36,"name":{"en-GB":"Cantaloupe","en-US":"Cantaloupe"},"length_mm":330,"weight_g":2800,"icon":"cantaloupe.svg"},
  {"week":40,"name":{"en-GB":"Watermelon","en-US":"Watermelon"},"length_mm":360,"weight_g":3400,"icon":"watermelon.svg"}
]' | parse_json %}

{% comment %} Get settings with defaults {% endcomment %}
{% assign custom_fields = trmnl.plugin_settings.custom_fields_values %}
{% assign locale = custom_fields.locale | default: "en-GB" %}
{% assign units = custom_fields.units | default: "metric" %}
{% if units == "auto" %}
  {% if locale == "en-US" %}
    {% assign units = "imperial" %}
  {% else %}
    {% assign units = "metric" %}
  {% endif %}
{% endif %}
{% assign month_anchor_day = custom_fields.month_anchor_day | default: 15 | plus: 0 %}

{% comment %} Resolve due date {% endcomment %}
{% assign due_date_str = null %}
{% if custom_fields.due_date != blank %}
  {% assign due_date_str = custom_fields.due_date %}
{% elsif custom_fields.due_month != blank %}
  {% assign due_date_str = custom_fields.due_month | append: "-" | append: month_anchor_day %}
{% endif %}

<div class="bump-compare bump-compare--quadrant" data-due-date="{{ due_date_str }}" data-locale="{{ locale }}" data-units="{{ units }}" data-weeks='{{ weeks_data | json }}'>
  <div class="week-display">
    <div class="week-number">Week <span id="current-week">--</span></div>
  </div>
  <div class="comparator">
    <div class="icon-container">
      <img id="comparator-icon" src="" alt="" style="display: none;" />
    </div>
    <div class="comparator-name" id="comparator-name">--</div>
    <div class="comparator-size" id="comparator-size">--</div>
  </div>
</div>

<script>
(function() {
  const container = document.querySelector('.bump-compare');
  if (!container) return;
  
  const dueDateStr = container.dataset.dueDate;
  const locale = container.dataset.locale || 'en-GB';
  const units = container.dataset.units || 'metric';
  const weeksData = JSON.parse(container.dataset.weeks || '[]');
  
  if (!dueDateStr) {
    document.getElementById('current-week').textContent = '?';
    document.getElementById('comparator-name').textContent = 'Set date';
    return;
  }
  
  const dueDate = new Date(dueDateStr + 'T00:00:00');
  if (isNaN(dueDate.getTime())) {
    document.getElementById('current-week').textContent = '?';
    document.getElementById('comparator-name').textContent = 'Invalid';
    return;
  }
  
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const daysToDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
  const week = Math.max(0, Math.min(40, Math.floor((280 - daysToDue) / 7)));
  
  let comparator = null;
  for (let i = weeksData.length - 1; i >= 0; i--) {
    if (weeksData[i].week <= week) {
      comparator = weeksData[i];
      break;
    }
  }
  
  if (!comparator) {
    comparator = weeksData[0];
  }
  
  document.getElementById('current-week').textContent = week;
  
  const name = comparator.name[locale] || comparator.name['en-GB'];
  document.getElementById('comparator-name').textContent = name;
  
  let lengthStr, weightStr;
  if (units === 'imperial') {
    const lengthIn = (comparator.length_mm / 25.4).toFixed(1);
    const weightOz = comparator.weight_g / 28.35;
    if (weightOz >= 16) {
      const lbs = Math.floor(weightOz / 16);
      const oz = Math.round(weightOz % 16);
      weightStr = lbs + 'lb ' + oz + 'oz';
    } else {
      weightStr = weightOz.toFixed(1) + 'oz';
    }
    lengthStr = lengthIn + 'in';
  } else {
    lengthStr = comparator.length_mm + 'mm';
    if (comparator.weight_g < 1) {
      weightStr = (comparator.weight_g * 1000).toFixed(0) + 'mg';
    } else {
      weightStr = comparator.weight_g + 'g';
    }
  }
  
  document.getElementById('comparator-size').textContent = lengthStr + ' Â· ' + weightStr;
  
  const iconEl = document.getElementById('comparator-icon');
  if (comparator.icon) {
    iconEl.src = '{{ icon_base_url }}/' + comparator.icon;
    iconEl.alt = name;
    iconEl.style.display = 'block';
  }
})();
</script>

<style>
.bump-compare {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 0.5rem;
  height: 100%;
}

.bump-compare--quadrant .week-number {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
}

.bump-compare--quadrant .icon-container {
  width: 64px;
  height: 64px;
}

.bump-compare--quadrant .comparator-name {
  font-size: 0.875rem;
  font-weight: 600;
}

.bump-compare--quadrant .comparator-size {
  font-size: 0.625rem;
  opacity: 0.8;
}

.week-display {
  margin-bottom: 0.5rem;
}

.week-number {
  font-weight: bold;
}

.comparator {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

.icon-container {
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-container img {
  max-width: 100%;
  max-height: 100%;
  image-rendering: pixelated;
}

.comparator-name {
  font-weight: 600;
}

.comparator-size {
  opacity: 0.8;
}
</style>

